(window.webpackJsonp=window.webpackJsonp||[]).push([[61],{371:function(t,s,v){"use strict";v.r(s);var _=v(10),n=Object(_.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"protobuf弹幕"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#protobuf弹幕"}},[t._v("#")]),t._v(" protobuf弹幕")]),t._v(" "),s("p",[t._v("2020年5月23日，哔哩哔哩网页端及移动端启用了新的默认弹幕 API，网页端弹幕显示的上限变为原弹幕池上限的两倍。")]),t._v(" "),s("p",[t._v("新的 API 是以 6min 为一个单位加载，即每次加载 6min 内的弹幕")]),t._v(" "),s("h2",{attrs:{id:"获取实时弹幕"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#获取实时弹幕"}},[t._v("#")]),t._v(" 获取实时弹幕")]),t._v(" "),s("blockquote",[s("p",[t._v("https://api.bilibili.com/x/v2/dm/web/seg.so （web端）")]),t._v(" "),s("p",[t._v("https://api.bilibili.com/x/v2/dm/list/seg.so （APP端）")]),t._v(" "),s("p",[t._v("https://i0.hdslb.com/bfs/dm/{data}.bin （BAS/代码弹幕专包）")])]),t._v(" "),s("p",[s("em",[t._v("请求方式：GET")])]),t._v(" "),s("p",[t._v("此接口与漫画弹幕相同")]),t._v(" "),s("p",[t._v("只能返回普通弹幕（"),s("code",[t._v("pool=1")]),t._v(" "),s("code",[t._v("mode=1-7")]),t._v("）和代码弹幕（"),s("code",[t._v("pool=2")]),t._v(" "),s("code",[t._v("mode=8")]),t._v("），BAS弹幕（"),s("code",[t._v("pool=2")]),t._v(" "),s("code",[t._v("mode=9")]),t._v("）请从"),s("RouterLink",{attrs:{to:"/docs/danmaku/danmaku_view_proto.html"}},[t._v("弹幕元数据")]),t._v("中获取")],1),t._v(" "),s("p",[t._v("互动弹幕（UP 主头像弹幕、关联视频、内嵌关注按钮）也不存在这个接口，请从"),s("RouterLink",{attrs:{to:"/docs/danmaku/danmaku_view_proto.html"}},[t._v("弹幕元数据")]),t._v("中获取")],1),t._v(" "),s("p",[s("strong",[t._v("注：仅获取 6min 的整数倍时间内的弹幕，6min 内最多弹幕数为 6000 条（如第一包中弹幕"),s("code",[t._v("progress")]),t._v("值域为0-360000）")])]),t._v(" "),s("p",[s("strong",[t._v("url参数：")])]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("参数名")]),t._v(" "),s("th",[t._v("类型")]),t._v(" "),s("th",[t._v("内容")]),t._v(" "),s("th",[t._v("必要性")]),t._v(" "),s("th",[t._v("备注")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("type")]),t._v(" "),s("td",[t._v("num")]),t._v(" "),s("td",[t._v("弹幕类")]),t._v(" "),s("td",[t._v("必要")]),t._v(" "),s("td",[t._v("1：视频弹幕"),s("br"),t._v("2：漫画弹幕")])]),t._v(" "),s("tr",[s("td",[t._v("oid")]),t._v(" "),s("td",[t._v("num")]),t._v(" "),s("td",[t._v("视频 cid")]),t._v(" "),s("td",[t._v("必要")]),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td",[t._v("pid")]),t._v(" "),s("td",[t._v("num")]),t._v(" "),s("td",[t._v("稿件 avid")]),t._v(" "),s("td",[t._v("非必要")]),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td",[t._v("segment_index")]),t._v(" "),s("td",[t._v("num")]),t._v(" "),s("td",[t._v("分包")]),t._v(" "),s("td",[t._v("必要")]),t._v(" "),s("td",[t._v("6min 一包")])]),t._v(" "),s("tr",[s("td",[t._v("pull_mode")]),t._v(" "),s("td",[t._v("num")]),t._v(" "),s("td",[t._v("（？）")]),t._v(" "),s("td",[t._v("非必要")]),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td",[t._v("ps")]),t._v(" "),s("td",[t._v("num")]),t._v(" "),s("td",[t._v("（？）")]),t._v(" "),s("td",[t._v("非必要")]),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td",[t._v("pe")]),t._v(" "),s("td",[t._v("num")]),t._v(" "),s("td",[t._v("（？）")]),t._v(" "),s("td",[t._v("非必要")]),t._v(" "),s("td")])])]),t._v(" "),s("p",[s("strong",[t._v("proto回复：")])]),t._v(" "),s("p",[t._v("proto定义见："),s("a",{attrs:{href:"../../grpc_api/bilibili/community/service/dm/v1/dm.proto"}},[t._v("bilibili.community.service.dm.v1.DmSegMobileReply")])]),t._v(" "),s("ul",[s("li",[s("p",[s("a",{attrs:{href:"https://protogen.marcgravell.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("protogen.marcgravell"),s("OutboundLink")],1),t._v(": 在线编译 protogen 工具, 无需再安装本地编译器(生成文件需加后缀"),s("code",[t._v("_pb2.py")]),t._v("才可使用)")])]),t._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://pypi.org/project/protobuf/",target:"_blank",rel:"noopener noreferrer"}},[t._v("protobuf pip"),s("OutboundLink")],1),t._v(": 可一键安装的 Python 的 protogen 解析库")])])]),t._v(" "),s("p",[t._v("消息"),s("code",[t._v("DmSegMobileReply")]),t._v("：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("名称")]),t._v(" "),s("th",[t._v("类型")]),t._v(" "),s("th",[t._v("含义")]),t._v(" "),s("th",[t._v("备注")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("elems")]),t._v(" "),s("td",[t._v("repeated DanmakuElem")]),t._v(" "),s("td",[t._v("弹幕条目")]),t._v(" "),s("td")])])]),t._v(" "),s("p",[t._v("消息"),s("code",[t._v("DanmakuElem")]),t._v("：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("名称")]),t._v(" "),s("th",[t._v("类型")]),t._v(" "),s("th",[t._v("含义")]),t._v(" "),s("th",[t._v("备注")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("id")]),t._v(" "),s("td",[t._v("int64")]),t._v(" "),s("td",[t._v("弹幕 dmid")]),t._v(" "),s("td",[t._v("唯一  可用于操作参数")])]),t._v(" "),s("tr",[s("td",[t._v("progress")]),t._v(" "),s("td",[t._v("int32")]),t._v(" "),s("td",[t._v("视频内弹幕出现时间")]),t._v(" "),s("td",[t._v("毫秒")])]),t._v(" "),s("tr",[s("td",[t._v("mode")]),t._v(" "),s("td",[t._v("int32")]),t._v(" "),s("td",[t._v("弹幕类型")]),t._v(" "),s("td",[t._v("1 2 3：普通弹幕"),s("br"),t._v("4：底部弹幕"),s("br"),t._v("5：顶部弹幕"),s("br"),t._v("6：逆向弹幕"),s("br"),t._v("7：高级弹幕"),s("br"),t._v("8：代码弹幕"),s("br"),t._v("9：BAS 弹幕（仅限于特殊弹幕专包）")])]),t._v(" "),s("tr",[s("td",[t._v("fontsize")]),t._v(" "),s("td",[t._v("int32")]),t._v(" "),s("td",[t._v("弹幕字号")]),t._v(" "),s("td",[t._v("18：小"),s("br"),t._v("25：标准"),s("br"),t._v("36：大")])]),t._v(" "),s("tr",[s("td",[t._v("color")]),t._v(" "),s("td",[t._v("uint32")]),t._v(" "),s("td",[t._v("弹幕颜色")]),t._v(" "),s("td",[t._v("十进制 RGB888 值")])]),t._v(" "),s("tr",[s("td",[t._v("midHash")]),t._v(" "),s("td",[t._v("string")]),t._v(" "),s("td",[t._v("发送者 mid 的 HASH")]),t._v(" "),s("td",[t._v("用于屏蔽用户和查看用户发送的所有弹幕，也可反查用户id")])]),t._v(" "),s("tr",[s("td",[t._v("content")]),t._v(" "),s("td",[t._v("string")]),t._v(" "),s("td",[t._v("弹幕内容")]),t._v(" "),s("td",[t._v("utf-8编码")])]),t._v(" "),s("tr",[s("td",[t._v("ctime")]),t._v(" "),s("td",[t._v("int64")]),t._v(" "),s("td",[t._v("弹幕发送时间")]),t._v(" "),s("td",[t._v("时间戳")])]),t._v(" "),s("tr",[s("td",[t._v("weight")]),t._v(" "),s("td",[t._v("int32")]),t._v(" "),s("td",[t._v("权重")]),t._v(" "),s("td",[t._v("用于智能屏蔽，根据弹幕语义及长度通过AI识别得出"),s("br"),t._v("范围：[0-10]"),s("br"),t._v("值越大权重越高")])]),t._v(" "),s("tr",[s("td",[t._v("action")]),t._v(" "),s("td",[t._v("string")]),t._v(" "),s("td",[t._v("动作？")]),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td",[t._v("pool")]),t._v(" "),s("td",[t._v("int32")]),t._v(" "),s("td",[t._v("弹幕池")]),t._v(" "),s("td",[t._v("0：普通池"),s("br"),t._v("1：字幕池"),s("br"),t._v("2：特殊池（代码/BAS弹幕）")])]),t._v(" "),s("tr",[s("td",[t._v("idStr")]),t._v(" "),s("td",[t._v("string")]),t._v(" "),s("td",[t._v("弹幕 dmid")]),t._v(" "),s("td",[t._v("字串形式"),s("br"),t._v("唯一  可用于操作参数")])]),t._v(" "),s("tr",[s("td",[t._v("attr")]),t._v(" "),s("td",[t._v("int32")]),t._v(" "),s("td",[t._v("弹幕属性位")]),t._v(" "),s("td",[t._v("bit0：保护"),s("br"),t._v("bit1：直播"),s("br"),t._v("bit2：高赞")])]),t._v(" "),s("tr",[s("td",[t._v("animation")]),t._v(" "),s("td",[t._v("string")]),t._v(" "),s("td",[t._v("动画？")]),t._v(" "),s("td")])])]),t._v(" "),s("p",[s("strong",[t._v("示例：")])]),t._v(" "),s("p",[t._v("获取视频"),s("code",[t._v("av810872(cid=1176840)")]),t._v("（炮姐）的实时弹幕分包 1")]),t._v(" "),s("p",[s("strong",[t._v("注：以下"),s("a",{attrs:{href:"../grpc_api/bilibili/community/service/dm/v1/dm.proto"}},[t._v("proto定义")]),t._v("需要编译，"),s("code",[t._v("bilibili.community.service.dm.v1.dm_pb2")]),t._v("并非通过 pypi 安装")])]),t._v(" "),s("div",{staticClass:"language-python line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" requests\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" google"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("protobuf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("text_format "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" text_format\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" bilibili"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("community"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("service"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("v1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dm_pb2 "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" Danmaku\n\nurl "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://api.bilibili.com/x/v2/dm/web/seg.so'")]),t._v("\nparams "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'type'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("         "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 弹幕类型")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'oid'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1176840")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cid")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'pid'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("810872")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# avid")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'segment_index'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 弹幕分段")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nresp "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" requests"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" params"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndata "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" resp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("content\n\ndanmaku_seg "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Danmaku"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DmSegMobileReply"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndanmaku_seg"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ParseFromString"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("text_format"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MessageToString"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("danmaku_seg"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elems"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" as_utf8"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br")])]),s("p",[t._v("输出：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('id: 711923911\nprogress: 47880\nmode: 1\nfontsize: 18\ncolor: 10092288\nmidHash: "59417e95"\ncontent: "世界第一电击公主殿下,遇到你是我一生最美好的风景!吾炮赛高,永生不离!唯我超电磁炮永世长存! "\nctime: 1418799826\nweight: 6\nidStr: "711923911"\nattr: 1\n')])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br")])])])}),[],!1,null,null,null);s.default=n.exports}}]);